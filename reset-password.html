<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RÃ©initialiser le mot de passe - TeachInspire</title>
  <link rel="icon" type="image/png" href="https://imagedelivery.net/BGb25Nzj8sQ1HtrebC39dQ/134736d6-5e59-461d-8594-dbd8c8d6c400/public">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&family=Courier+New:wght@500&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-bg': '#f8f7f2',
            'brand-text': '#2c3d57',
            'brand-primary-accent': '#85a2a3',
            'brand-secondary-accent': '#f1d263',
            'brand-card-bg': '#ffffff',
            'brand-muted-text': '#6b7280',
            'brand-error': '#ef4444',
            'brand-success': '#10b981',
            'brand-info': '#3b82f6',
          },
          fontFamily: {
            'playfair': ['Playfair Display', 'serif'],
            'inter': ['Inter', 'sans-serif'],
            'courier': ['Courier New', 'Courier', 'monospace'],
          },
          boxShadow: {
            'brand': '0 4px 6px -1px rgba(44, 61, 87,0.07), 0 2px 4px -2px rgba(44, 61, 87,0.07)',
            'brand-lg': '0 10px 15px -3px rgba(44, 61, 87, 0.1), 0 4px 6px -2px rgba(44, 61, 87, 0.05)'
          }
        }
      }
    }
  </script>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@^19.0.0",
      "react-dom/client": "https://esm.sh/react-dom@^19.0.0/client",
      "react-dom/": "https://esm.sh/react-dom@^19.0.0/",
      "react/": "https://esm.sh/react@^19.0.0/"
    }
  }
  </script>
</head>
<body class="bg-brand-bg">
  <div id="root"></div>
  <script type="module">
    import React from 'react';
    import { createRoot } from 'react-dom/client';
    import { translations } from './constants.js';
    
    // Simple language context for this standalone page
    const getInitialLanguage = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const urlLang = urlParams.get('lang');
      const storedLang = localStorage.getItem('preferred-language');
      return urlLang || storedLang || 'fr';
    };

    const ResetPasswordPage = () => {
      const [language, setLanguage] = React.useState(getInitialLanguage);
      const t = translations[language];

      const handleBackToLogin = () => {
        window.location.href = `/app.html?lang=${language}`;
      };

      const mockLanguageContext = {
        translations: {
          ...t,
          currentLanguage: language
        }
      };

      return React.createElement('div', { className: 'min-h-screen bg-brand-bg' }, [
        // Language selector
        React.createElement('div', {
          key: 'language-selector',
          className: 'absolute top-4 right-4 z-10'
        }, [
          React.createElement('button', {
            key: 'fr-btn',
            onClick: () => setLanguage('fr'),
            className: `px-3 py-1 text-sm font-medium rounded-l-md border ${language === 'fr' ? 'bg-brand-primary-accent text-white border-brand-primary-accent' : 'bg-white text-brand-text border-gray-300 hover:bg-gray-50'}`
          }, 'FR'),
          React.createElement('button', {
            key: 'en-btn', 
            onClick: () => setLanguage('en'),
            className: `px-3 py-1 text-sm font-medium rounded-r-md border-l-0 border ${language === 'en' ? 'bg-brand-primary-accent text-white border-brand-primary-accent' : 'bg-white text-brand-text border-gray-300 hover:bg-gray-50'}`
          }, 'EN')
        ]),

        // Main content
        React.createElement('div', {
          key: 'main-content',
          className: 'min-h-screen flex items-center justify-center p-4'
        }, [
          React.createElement('div', {
            key: 'container',
            className: 'w-full max-w-md'
          }, [
            React.createElement('div', {
              key: 'card',
              className: 'bg-brand-card-bg rounded-lg shadow-brand-lg p-8'
            }, [
              React.createElement('div', {
                key: 'header',
                className: 'text-center mb-8'
              }, [
                React.createElement('img', {
                  key: 'logo',
                  src: 'https://res.cloudinary.com/ducvoebot/image/upload/v1747991665/Teachinspire_logo_transparent_yjt3uf.png',
                  alt: 'TeachInspire Logo',
                  className: 'mx-auto h-12 w-auto mb-4'
                }),
                React.createElement('h2', {
                  key: 'title',
                  className: 'text-2xl font-playfair font-bold text-brand-text mb-2'
                }, t.auth.resetPassword.title),
                React.createElement('p', {
                  key: 'subtitle',
                  className: 'text-brand-muted-text'
                }, t.auth.resetPassword.subtitle)
              ]),

              // Reset Password Form Component will be rendered here
              React.createElement(ResetPasswordForm, {
                key: 'form',
                translations: mockLanguageContext.translations,
                onBackToLogin: handleBackToLogin
              })
            ])
          ])
        ])
      ]);
    };

    // Reset Password Form Component
    const ResetPasswordForm = ({ translations, onBackToLogin }) => {
      const [token, setToken] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      const [isSuccess, setIsSuccess] = React.useState(false);
      const [error, setError] = React.useState('');
      const [validationErrors, setValidationErrors] = React.useState([]);

      // Extract token from URL on component mount
      React.useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        
        if (urlToken) {
          setToken(urlToken);
        } else {
          setError(translations.auth.resetPassword.noToken);
        }
      }, [translations]);

      // Validate password in real-time
      React.useEffect(() => {
        if (password) {
          const errors = [];
          
          if (password.length < 12) {
            errors.push(translations.auth.resetPassword.validation.minLength);
          }
          
          if (!/[A-Z]/.test(password)) {
            errors.push(translations.auth.resetPassword.validation.uppercase);
          }
          
          if (!/[a-z]/.test(password)) {
            errors.push(translations.auth.resetPassword.validation.lowercase);
          }
          
          if (!/\d/.test(password)) {
            errors.push(translations.auth.resetPassword.validation.number);
          }
          
          if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            errors.push(translations.auth.resetPassword.validation.special);
          }
          
          setValidationErrors(errors);
        } else {
          setValidationErrors([]);
        }
      }, [password, translations]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!token) {
          setError(translations.auth.resetPassword.noToken);
          return;
        }

        if (!password || !confirmPassword) {
          setError(translations.auth.resetPassword.fieldsRequired);
          return;
        }

        if (password !== confirmPassword) {
          setError(translations.auth.resetPassword.passwordMismatch);
          return;
        }

        if (validationErrors.length > 0) {
          setError(translations.auth.resetPassword.weakPassword);
          return;
        }

        setIsLoading(true);
        setError('');

        try {
          const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              token,
              password
            }),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Auto-login user after successful password reset
            if (data.token && data.user) {
              localStorage.setItem('teachinspire-auth-token', data.token);
              localStorage.setItem('teachinspire-user', JSON.stringify(data.user));
            }
            
            setIsSuccess(true);
            
            // Redirect to app after 3 seconds
            setTimeout(() => {
              window.location.href = `/app.html?lang=${translations.currentLanguage}`;
            }, 3000);
          } else {
            setError(data.error?.message || translations.auth.resetPassword.errorGeneric);
          }
        } catch (error) {
          console.error('Reset password error:', error);
          setError(translations.auth.resetPassword.errorGeneric);
        } finally {
          setIsLoading(false);
        }
      };

      if (isSuccess) {
        return React.createElement('div', { className: 'text-center' }, [
          React.createElement('div', {
            key: 'success-icon',
            className: 'w-16 h-16 bg-brand-success rounded-full flex items-center justify-center mx-auto mb-4'
          }, [
            React.createElement('svg', {
              key: 'check-icon',
              className: 'w-8 h-8 text-white',
              fill: 'none',
              stroke: 'currentColor',
              viewBox: '0 0 24 24'
            }, [
              React.createElement('path', {
                key: 'check-path',
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M5 13l4 4L19 7'
              })
            ])
          ]),
          React.createElement('h3', {
            key: 'success-title',
            className: 'text-xl font-semibold text-brand-text mb-4'
          }, translations.auth.resetPassword.successTitle),
          React.createElement('p', {
            key: 'success-message',
            className: 'text-brand-muted-text mb-6'
          }, translations.auth.resetPassword.successMessage),
          React.createElement('div', {
            key: 'loading-indicator',
            className: 'flex items-center justify-center'
          }, [
            React.createElement('div', {
              key: 'spinner',
              className: 'animate-spin rounded-full h-6 w-6 border-b-2 border-brand-primary-accent'
            }),
            React.createElement('span', {
              key: 'redirect-text',
              className: 'ml-2 text-brand-muted-text'
            }, translations.auth.resetPassword.redirecting)
          ])
        ]);
      }

      return React.createElement('form', {
        onSubmit: handleSubmit,
        className: 'space-y-6'
      }, [
        React.createElement('div', { key: 'password-field' }, [
          React.createElement('label', {
            key: 'password-label',
            htmlFor: 'password',
            className: 'block text-sm font-medium text-brand-text mb-2'
          }, translations.auth.resetPassword.passwordLabel),
          React.createElement('input', {
            key: 'password-input',
            type: 'password',
            id: 'password',
            value: password,
            onChange: (e) => setPassword(e.target.value),
            placeholder: translations.auth.resetPassword.passwordPlaceholder,
            className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary-accent focus:border-transparent transition-colors font-inter',
            disabled: isLoading,
            required: true
          })
        ]),
        
        React.createElement('div', { key: 'confirm-password-field' }, [
          React.createElement('label', {
            key: 'confirm-password-label',
            htmlFor: 'confirmPassword',
            className: 'block text-sm font-medium text-brand-text mb-2'
          }, translations.auth.resetPassword.confirmPasswordLabel),
          React.createElement('input', {
            key: 'confirm-password-input',
            type: 'password',
            id: 'confirmPassword',
            value: confirmPassword,
            onChange: (e) => setConfirmPassword(e.target.value),
            placeholder: translations.auth.resetPassword.confirmPasswordPlaceholder,
            className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary-accent focus:border-transparent transition-colors font-inter',
            disabled: isLoading,
            required: true
          })
        ]),
        
        // Password validation feedback
        validationErrors.length > 0 && React.createElement('div', {
          key: 'validation-errors',
          className: 'bg-yellow-50 border border-yellow-200 rounded-lg p-4'
        }, [
          React.createElement('h4', {
            key: 'validation-title',
            className: 'text-sm font-medium text-yellow-800 mb-2'
          }, translations.auth.resetPassword.passwordRequirements),
          React.createElement('ul', {
            key: 'validation-list',
            className: 'text-sm text-yellow-700 space-y-1'
          }, validationErrors.map((error, index) => 
            React.createElement('li', {
              key: `validation-${index}`,
              className: 'flex items-center'
            }, [
              React.createElement('span', {
                key: 'bullet',
                className: 'w-1 h-1 bg-yellow-600 rounded-full mr-2'
              }),
              error
            ])
          ))
        ]),
        
        error && React.createElement('div', {
          key: 'error',
          className: 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm'
        }, error),
        
        React.createElement('button', {
          key: 'submit-button',
          type: 'submit',
          disabled: isLoading || validationErrors.length > 0 || !token,
          className: `w-full bg-gradient-to-r from-brand-primary-accent to-brand-secondary-accent text-white py-3 px-6 rounded-full font-inter font-semibold transition-all duration-200 transform ${(isLoading || validationErrors.length > 0 || !token) ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg hover:scale-105'}`
        }, isLoading ? translations.auth.resetPassword.resetting : translations.auth.resetPassword.resetButton),
        
        React.createElement('div', {
          key: 'back-link',
          className: 'text-center'
        }, [
          React.createElement('button', {
            key: 'back-button',
            type: 'button',
            onClick: onBackToLogin,
            className: 'text-brand-primary-accent hover:text-brand-secondary-accent transition-colors font-medium text-sm'
          }, translations.auth.resetPassword.backToLogin)
        ])
      ]);
    };

    // Mount the app
    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(ResetPasswordPage));
  </script>
</body>
</html>